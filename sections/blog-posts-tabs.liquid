{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
    background-color: {{ section.settings.bg_color }};
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  /* Header Styles */
  .blog-posts-tabs__header {
    text-align: center;
    margin-bottom: 4rem;
    max-width: 80rem;
    margin-left: auto;
    margin-right: auto;
  }

  .blog-posts-tabs__title {
    font-family: var(--font-heading-family);
    font-size: 5rem; /* Large Headline */
    font-weight: 400;
    margin: 0 0 1rem;
    letter-spacing: -0.02em;
  }

  .blog-posts-tabs__description {
    font-size: 1.6rem;
    line-height: 1.5;
    color: rgba(var(--color-foreground-rgb), 0.7);
  }

  /* Tabs Navigation - Pill Style */
  .blog-tabs-nav {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 5rem;
  }

  .blog-tab-button {
    background: transparent;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    color: rgba(var(--color-foreground-rgb), 0.6);
    transition: all 0.3s ease;
    border-radius: 50px; /* Pill shapes */
    border: 1px solid var(--color-foreground);
  }

  .blog-tab-button:hover {
    color: rgb(var(--color-foreground-rgb));
    border-color: rgba(var(--color-foreground-rgb), 0.4);
  }

  .blog-tab-button.active {
    color: rgb(var(--color-button-text));
    background-color: rgba(var(--color-foreground-rgb), 0.4); /* Muted active state */
    border-color: transparent;
  }

  /* Override for "All" tab or general active if darker is preferred */
  .blog-tab-button.active {
     background-color: #B2BDBD; /* Approximate color from mockup grey/green pill */
     color: #000;
  }

  /* Grid Layout - Scoop Style */
  .blog-articles-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 3rem;
  }

  @media screen and (min-width: 750px) {
    .blog-articles-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media screen and (min-width: 990px) {
    .blog-articles-grid {
      grid-template-columns: repeat(3, 1fr);
      grid-auto-rows: min-content; /* Ensure rows don't stretch unnecessarily */
    }

    /* Hero Item Logic: First item spans 2 cols - ONLY for 'All' panel */
    #panel-all .blog-articles-grid > .blog-article-card:nth-child(1) {
      grid-column: span 2;
      grid-row: span 2;
    }
  }

  /* Article Card Styling */
  .blog-article-card {
    display: flex;
    flex-direction: column;
    /* Transparent, clean look */
    background-color: transparent;
  }

  .article-card__image-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: 4px; /* Slight roundness */
    margin-bottom: 1.6rem;
    background-color: #f7f7f7; /* Placeholder bg */
  }

  .article-card__image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .blog-article-card:hover .article-card__image {
    transform: scale(1.03);
  }

  .article-card__content {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }

  .article-card__title {
    font-family: var(--font-heading-family);
    font-size: 2.2rem;
    line-height: 1.25;
    margin: 0;
    font-weight: 400; /* Serif usually looks better lighter */
    color: rgb(var(--color-foreground-rgb));
  }

  .article-card__title a {
    text-decoration: none;
    color: inherit;
  }

  .article-card__meta {
    order: 2;
  }

  .article-card__tag {
    font-family: var(--font-body-family);
    font-size: 1rem;
    text-transform: uppercase;
    color: rgba(var(--color-foreground-rgb), 0.5);
  }

  .article-card__excerpt {
    font-size: 1.5rem;
    line-height: 1.5;
    color: rgba(var(--color-foreground-rgb), 0.75);
    margin-top: 0.5rem;
    display: none;
  }
  .blog-articles-grid .article-card__excerpt {
     display: block;
  }

  /* Specific styles for the HERO item on Desktop */
  /* @media screen and (min-width: 990px) {
    .blog-articles-grid > .blog-article-card:nth-child(1) .article-card__image-wrapper {
       padding-bottom: 66.6%;
    }

    .blog-articles-grid > .blog-article-card:nth-child(1) .article-card__title {
      font-size: 4rem;
      line-height: 1.1;
      margin-bottom: 1rem;
    }

    .blog-articles-grid > .blog-article-card:nth-child(1) .article-card__content {
    }
  } */

  /* Show More Button */
  .blog-show-more-container {
    text-align: center;
    margin-top: 5rem;
    padding-top: 2rem;
    border-top: 1px solid rgba(var(--color-foreground-rgb), 0.1);
  }

  .blog-show-more-btn {
    display: inline-block;
    padding: 1.2rem 4rem;
    background-color: transparent;
    color: rgb(var(--color-foreground-rgb));
    text-decoration: none;
    border: 1px solid rgba(var(--color-foreground-rgb), 0.3);
    border-radius: 4px;
    font-weight: 600;
    transition: all 0.3s;
    cursor: pointer;
    font-size: 1.3rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .blog-show-more-btn:hover {
    border-color: rgb(var(--color-foreground-rgb));
    background-color: rgba(var(--color-foreground-rgb), 0.05);
  }

  .blog-show-more-btn.hidden {
    display: none;
  }

  .tab-panel {
    display: none;
    animation: fadeIn 0.4s ease-out;
  }

  .tab-panel.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
{%- endstyle -%}

<div class="blog-posts-tabs section-{{ section.id }}-padding color-{{ section.settings.color_scheme }} gradient">
  <div class="page-width">
    <div class="blog-posts-tabs__header">
      {%- if section.settings.heading != blank -%}
        <h2 class="blog-posts-tabs__title">{{ section.settings.heading | escape }}</h2>
      {%- endif -%}
      {%- if section.settings.description != blank -%}
        <div class="blog-posts-tabs__description rte">
          {{ section.settings.description }}
        </div>
      {%- endif -%}
    </div>

    <!-- Tabs Navigation -->
    <div class="blog-tabs-nav" role="tablist">
      <button class="blog-tab-button active" role="tab" aria-selected="true" aria-controls="panel-all" data-tab="all">
        All
      </button>
      {%- for block in section.blocks -%}
        {%- assign blog_handle = block.settings.blog -%}
        {%- assign blog_obj = blogs[blog_handle] -%}
        {%- if blog_obj != blank -%}
          <button
            class="blog-tab-button"
            role="tab"
            aria-selected="false"
            aria-controls="panel-{{ block.id }}"
            data-tab="{{ block.id }}"
          >
            {{ block.settings.title | default: blog_obj.title }}
          </button>
        {%- endif -%}
      {%- endfor -%}
    </div>

    <!-- Tabs Content -->

    <!-- 'All' Tab Panel -->
    <div id="panel-all" class="tab-panel active" role="tabpanel">
      <div class="blog-articles-grid">
        {%- assign all_articles = '' | split: '' -%}
        {%- for block in section.blocks -%}
          {%- assign b = blogs[block.settings.blog] -%}
          {%- if b != blank -%}
            {%- assign all_articles = all_articles | concat: b.articles -%}
          {%- endif -%}
        {%- endfor -%}

        {%- assign all_articles_sorted = all_articles | sort: 'published_at' | reverse | slice: 0, 12 -%}

        {%- for article in all_articles_sorted -%}
          {% render 'blog-post-card-snippet', article: article, section: section, blog_title: article.blog.title %}
        {%- endfor -%}
      </div>
      <!-- No Show More for 'All' tab intentionally to avoid complexity -->
    </div>

    <!-- Individual Blog Panels -->
    {%- for block in section.blocks -%}
      {%- assign blog_handle = block.settings.blog -%}
      {%- assign blog_obj = blogs[blog_handle] -%}
      {%- if blog_obj != blank -%}
        <div id="panel-{{ block.id }}" class="tab-panel" role="tabpanel">
          <div
            class="blog-articles-grid"
            data-blog-handle="{{ blog_handle }}"
            data-next-page="2"
            data-blog-title="{{ blog_obj.title }}"
          >
            {%- for article in blog_obj.articles limit: section.settings.articles_per_load -%}
              {% render 'blog-post-card-snippet', article: article, section: section, blog_title: blog_obj.title %}
            {%- endfor -%}
          </div>

          {%- if blog_obj.articles_count > section.settings.articles_per_load -%}
            <div class="blog-show-more-container">
              <button class="blog-show-more-btn" data-target="#panel-{{ block.id }}">Show More</button>
            </div>
          {%- endif -%}
        </div>
      {%- endif -%}
    {%- endfor -%}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.blog-tab-button');
    const panels = document.querySelectorAll('.tab-panel');

    // Tab Switching
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Deactivate all
        tabs.forEach(t => {
            t.classList.remove('active');
            t.setAttribute('aria-selected', 'false');
        });
        panels.forEach(p => p.classList.remove('active'));

        // Activate clicked
        tab.classList.add('active');
        tab.setAttribute('aria-selected', 'true');
        const targetId = tab.dataset.tab;
        
        if (targetId === 'all') {
            document.getElementById('panel-all').classList.add('active');
        } else {
            document.getElementById(`panel-${targetId}`).classList.add('active');
        }
      });
    });

    // Show More Logic
    const cardTemplate = (data) => `
        <div class="blog-article-card">
           <div class="article-card__image-wrapper" style="padding-bottom: {{ section.settings.image_ratio }}%;">
              <a href="${data.link}" class="article-card__image-link">
                <img src="${data.image}" class="article-card__image" loading="lazy">
              </a>
           </div>
           <div class="article-card__content">
             <h4 class="article-card__title"><a href="${data.link}">${data.title}</a></h4>
             ${data.showLabel ? `<div class="article-card__meta"><span class="article-card__tag">${data.tag}</span></div>` : ''}
             ${data.excerpt ? `<div class="article-card__excerpt">${data.excerpt}</div>` : ''}
           </div>
        </div>
    `;

    const loadMoreBtns = document.querySelectorAll('.blog-show-more-btn');
    loadMoreBtns.forEach(btn => {
      btn.addEventListener('click', async function() {
        const panelId = this.dataset.target;
        const panel = document.querySelector(panelId);
        const grid = panel.querySelector('.blog-articles-grid');
        const blogHandle = grid.dataset.blogHandle;
        const blogTitle = grid.dataset.blogTitle;
        const nextPage = parseInt(grid.dataset.nextPage);
        const showLabel = {{ section.settings.show_blog_label | json }};
        
        this.textContent = 'Loading...';
        this.disabled = true;

        try {
            const response = await fetch(`/blogs/${blogHandle}?page=${nextPage}`);
            const text = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            
            // Attempt to find articles using common selectors
            let newArticles = doc.querySelectorAll('.blog-articles .blog-articles__article, .grid__item article, .blog-post-card, .article-card');
            
            // Fallback generic search
            if (newArticles.length === 0) {
                 newArticles = doc.querySelectorAll('article');
            }

            let addedCount = 0;
            if (newArticles.length > 0) {
                newArticles.forEach(node => {
                    const linkEl = node.querySelector('a[href*="/blogs/"][href*="/' + blogHandle + '/"]');
                    if(!linkEl) return;
                    
                    const link = linkEl.href;
                    const img = node.querySelector('img');
                    const title = node.querySelector('h2, h3, .h3, .h2, .article-title')?.innerText.trim() || 'Untitled';
                    const excerpt = node.querySelector('p, .rte')?.innerText.trim() || '';
                    
                    const div = document.createElement('div');
                    div.innerHTML = cardTemplate({
                        link, 
                        image: img ? img.src : '', 
                        title, 
                        excerpt: excerpt.substring(0, 100) + '...',
                        tag: blogTitle,
                        showLabel: showLabel
                    });
                    
                    grid.appendChild(div.firstElementChild);
                    addedCount++;
                });
            }
            
            if (addedCount > 0) {
                grid.dataset.nextPage = nextPage + 1;
                this.textContent = 'Show More';
                this.disabled = false;
            } else {
                this.style.display = 'none'; // Hide if no more found
            }

        } catch (e) {
            console.error(e);
            this.textContent = 'Error';
        }
      });
    });
  });
</script>

{% schema %}
{
  "name": "Live The Scoop Blog",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "The Scoop"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description",
      "default": "<p>Feeding you the best possible inputs, for your best possible health, so you can live your best possible life.</p>"
    },
    {
      "type": "range",
      "id": "articles_per_load",
      "min": 4,
      "max": 12,
      "step": 1,
      "label": "Articles per load",
      "default": 7
    },
    {
      "type": "checkbox",
      "id": "show_excerpt",
      "default": false,
      "label": "Show Excerpt"
    },
    {
      "type": "checkbox",
      "id": "show_blog_label",
      "default": true,
      "label": "Show Blog Label"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "options": [
        { "value": "100", "label": "Square" },
        { "value": "66.6", "label": "Portrait (2:3)" },
        { "value": "56.25", "label": "Landscape (16:9)" }
      ],
      "default": "56.25",
      "label": "Image Ratio"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 60
    }
  ],
  "blocks": [
    {
      "type": "blog_category",
      "name": "Blog Category",
      "settings": [
        {
          "type": "blog",
          "id": "blog",
          "label": "Blog"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Custom Tab Label",
          "info": "Leave blank to use Blog title"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Live The Scoop Blog",
      "blocks": [
        {
          "type": "blog_category"
        }
      ]
    }
  ]
}
{% endschema %}
