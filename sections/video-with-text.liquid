{% comment %}
Video Grid â€“ Click opens popup video
{% endcomment %}

<style>
.video-grid-section {
  padding: {{ section.settings.padding_top }}px 0 {{ section.settings.padding_bottom }}px;
}

.video-grid-section h2 {
  text-align: center;
  margin-bottom: 24px;
}

.video-swiper .swiper-slide {
  cursor: pointer;
}

.video-thumb video,
.video-thumb img {
  width: 100%;
  display: block;
  border-radius: 8px;
}

/* MODAL */
.video-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.video-modal-content {
  width: 90%;
  max-width: 900px;
  aspect-ratio: 16/9;
  position: relative;
}

.video-modal iframe,
.video-modal video {
  width: 100%;
  height: 100%;
}

.video-close {
  position: absolute;
  top: -40px;
  right: 0;
  font-size: 32px;
  background: none;
  border: 0;
  color: #fff;
  cursor: pointer;
}
</style>

<section class="video-grid-section">
  <div class="container--lg">

    {% if section.settings.section_title %}
      <h2>{{ section.settings.section_title }}</h2>
    {% endif %}

    <div class="swiper video-swiper">
      <div class="swiper-wrapper">

        {% for block in section.blocks %}
          <div class="swiper-slide">

            {% if block.settings.source == 'uploaded' %}
              <div class="video-thumb"
                   data-type="local"
                   data-src="{{ block.settings.video.sources[0].url }}">
                {{ block.settings.video | video_tag: controls: true, muted: true }}
              </div>

            {% else %}
              <div class="video-thumb"
                   data-type="{{ block.settings.video_url.type }}"
                   data-src="{{ block.settings.video_url | video_url }}">
                {% if block.settings.cover_image %}
                  {{ block.settings.cover_image | image_url: width: 800 | image_tag }}
                {% endif %}
              </div>
            {% endif %}

          </div>
        {% endfor %}

      </div>

      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>

  </div>
</section>

<!-- MODAL -->
<div class="video-modal" id="video-modal">
  <div class="video-modal-content">
    <button class="video-close">&times;</button>

    <iframe id="video-iframe"
            frameborder="0"
            allow="autoplay; fullscreen"
            allowfullscreen
            style="display:none"></iframe>

    <video id="modal-video" controls playsinline style="display:none">
      <source id="modal-video-source" type="video/mp4">
    </video>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css">
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {

  new Swiper('.video-swiper', {
    slidesPerView: 4,
    spaceBetween: 16,
    navigation: {
      nextEl: '.swiper-button-next',
      prevEl: '.swiper-button-prev'
    },
    breakpoints: {
      0: { slidesPerView: 1.2 },
      768: { slidesPerView: 3 },
      1024: { slidesPerView: 4 }
    }
  });

  const modal = document.getElementById('video-modal');
  const iframe = document.getElementById('video-iframe');
  const video = document.getElementById('modal-video');
  const source = document.getElementById('modal-video-source');

  document.body.addEventListener('click', function (e) {
    const thumb = e.target.closest('.video-thumb');
    if (!thumb) return;

    modal.style.display = 'flex';

    iframe.style.display = 'none';
    video.style.display = 'none';
    iframe.src = '';
    source.src = '';

    const type = thumb.dataset.type;
    const src = thumb.dataset.src;

    if (type === 'youtube' || type === 'vimeo') {
      iframe.src = src + '?autoplay=1';
      iframe.style.display = 'block';
    } else {
      source.src = src;
      video.load();
      video.play();
      video.style.display = 'block';
    }
  });

  function closeModal() {
    modal.style.display = 'none';
    iframe.src = '';
    video.pause();
    video.currentTime = 0;
  }

  document.querySelector('.video-close').addEventListener('click', closeModal);
  modal.addEventListener('click', e => {
    if (e.target === modal) closeModal();
  });

});
</script>

{% schema %}
{
  "name": "Video Grid Popup",
  "settings": [
    { "type": "text", "id": "section_title", "label": "Title" },
    { "type": "range", "id": "padding_top", "label": "Padding Top", "min": 0, "max": 100, "step": 1, "default": 30 },
    { "type": "range", "id": "padding_bottom", "label": "Padding Bottom", "min": 0, "max": 100, "step": 1, "default": 30 }
  ],
  "blocks": [
    {
      "type": "video",
      "name": "Video",
      "settings": [
        {
          "type": "select",
          "id": "source",
          "label": "Video Source",
          "options": [
            { "value": "uploaded", "label": "Uploaded" },
            { "value": "url", "label": "YouTube / Vimeo" }
          ],
          "default": "uploaded"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Uploaded Video",
          "visible_if": "{{ block.settings.source == 'uploaded' }}"
        },
        {
          "type": "video_url",
          "label": "Video Source",
          "id": "video_url",
          "accept": ["youtube", "vimeo"],
          "visible_if": "{{ block.settings.source == 'url' }}"
        },
        {
          "type": "image_picker",
          "id": "cover_image",
          "label": "Cover Image",
          "visible_if": "{{ block.settings.source == 'url' }}"
        }
      ]
    }
  ],
  "presets": [{ "name": "Video Grid Popup" }]
}
{% endschema %}
