{%- style -%}
  .ingredients-optimized {
    --active-color: #1d3a2f; /* Dark green similar to AG1 */
    --card-bg: #f9f9f9;
    --modal-bg: #ffffff;
    --text-muted: #666666;
  }

  .ingredients-optimized__header {
    margin-bottom: 40px;
    max-width: 800px;
  }

  .ingredients-optimized__title {
    margin: 0 0 16px;
    font-size: clamp(32px, 5vw, 56px);
    line-height: 1.1;
    font-family: var(--font-h1--family);
    font-weight: var(--font-h1--weight);
  }

  .ingredients-optimized__description {
    font-size: 18px;
    line-height: 1.5;
    color: var(--text-muted);
    margin-bottom: 24px;
    max-width: 600px;
  }

  .ingredients-optimized__cta {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    color: var(--active-color);
    text-decoration: none;
    border-bottom: 1px solid currentColor;
    padding-bottom: 2px;
    transition: opacity 0.2s;
  }

  .ingredients-optimized__cta:hover {
    opacity: 0.8;
  }

  /* Navigation Tabs */
  .ingredients-optimized__nav-wrapper {
    margin-bottom: 48px;
    position: sticky;
    top: 60px;
    background: var(--color-background);
    z-index: 20;
    padding: 10px 0;
    transition: top 0.3s;
  }

  /* Handle cases where there might not be a sticky header */
  .header-wrapper--none + main .ingredients-optimized__nav-wrapper {
    top: 0;
  }

  .ingredients-optimized__nav {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: 4px 0;
  }

  .ingredients-optimized__nav::-webkit-scrollbar {
    display: none;
  }

  .ingredients-optimized__tab {
    background: transparent;
    border: 1px solid #e1e1e1;
    border-radius: 4px;
    padding: 8px 16px;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-muted);
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
    text-transform: capitalize;
    font-family: var(--font-body--family);
  }

  .ingredients-optimized__tab:hover {
    border-color: #333;
    color: #333;
  }

  .ingredients-optimized__tab.is-active {
    background: #1d3a2f;
    border-color: #1d3a2f;
    color: white;
  }

  .ingredients-optimized__tab.is-active::after {
    display: none;
  }

  /* Grid */
  .ingredients-optimized__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    column-gap: 20px;
    row-gap: 40px;
  }

  @media screen and (min-width: 750px) {
    .ingredients-optimized__grid {
      grid-template-columns: repeat(4, 1fr);
      column-gap: 24px;
      row-gap: 48px;
    }
  }

  @media screen and (min-width: 1200px) {
    .ingredients-optimized__grid {
      grid-template-columns: repeat(6, 1fr);
    }
  }

  /* Card */
  .ingredient-card {
    background: transparent;
    border-radius: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    cursor: pointer;
    transition: opacity 0.2s;
    text-align: left;
    box-shadow: none;
    border: none;
  }

  .ingredient-card:hover {
    transform: none;
    box-shadow: none;
    opacity: 0.8;
  }

  .ingredient-card__image-wrapper {
    width: 100%;
    margin: 0 0 12px 0;
    aspect-ratio: 0.8;
    position: relative;
    background-color: #f4f4f4;
    overflow: hidden;
  }

  .ingredient-card:hover .ingredient-card__image-wrapper {
    transform: none;
  }

  .ingredient-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .ingredient-card__title {
    margin: 0;
    font-size: 11px;
    font-weight: 600;
    line-height: 1.4;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-family: var(--font-body--family);
  }

  .ingredient-card__category { display: none; }

  /* Side Drawer Modal */
  .ingredients-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 100;
    display: flex;
    justify-content: flex-end;
    visibility: hidden;
    pointer-events: none;
    transition: visibility 0s 0.4s;
  }

  .ingredients-modal.is-active {
    visibility: visible;
    pointer-events: auto;
    transition: visibility 0s 0s;
  }

  .ingredients-modal__overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(2px);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .ingredients-modal.is-active .ingredients-modal__overlay {
    opacity: 1;
  }

  .ingredients-modal__container {
    position: relative;
    background: white;
    width: 100%;
    max-width: 500px;
    height: 100%;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
    box-shadow: -5px 0 25px rgba(0,0,0,0.1);
  }

  .ingredients-modal.is-active .ingredients-modal__container {
    transform: translateX(0);
    opacity: 1;
  }

  @media screen and (min-width: 750px) {
    .ingredients-modal__container {
      border-radius: 0;
      flex-direction: column;
      margin: 0;
      height: 100%;
    }
  }

  .ingredients-modal__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid transparent;
  }

  .ingredients-modal__cat {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #666;
    font-weight: 500;
  }

  .ingredients-modal__close {
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    color: #333;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .ingredients-modal__close svg {
    width: 24px;
    height: 24px;
  }

  .ingredients-modal__media {
    width: 100%;
    aspect-ratio: 1.2;
    background: #f0f0f0;
    position: relative;
  }

  .ingredients-modal__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .ingredients-modal__content {
    padding: 32px 24px;
    flex: 1;
  }

  .ingredients-modal__title {
    font-family: var(--font-h1--family);
    font-size: 32px;
    font-weight: 400;
    margin: 0 0 32px 0;
    line-height: 1.2;
  }

  .ingredients-modal__section {
    margin-bottom: 32px;
  }

  .ingredients-modal__section-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    margin-bottom: 12px;
    letter-spacing: 0.05em;
    color: #000;
  }

  .ingredients-modal__section-text {
    font-size: 15px;
    line-height: 1.6;
    color: #333;
  }

  .ingredients-modal__section-text p { margin-bottom: 0.5em; }
  .ingredients-modal__section-text ul { padding-left: 20px; margin: 0; }
  .ingredients-modal__section-text li { margin-bottom: 8px; }

  .ingredients-modal__nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-top: 1px solid #eee;
    background: white;
    position: sticky;
    bottom: 0;
  }

  .ingredients-modal__nav-controls {
    display: flex;
    gap: 16px;
  }

  .ingredients-modal__nav-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: #000;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s;
  }

  .ingredients-modal__nav-btn:disabled {
    opacity: 0.2;
    cursor: not-allowed;
  }

  .ingredients-modal__counter {
    font-size: 12px;
    color: #666;
    font-weight: 500;
  }

  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  [data-ingredient-hidden="true"] {
    display: none;
  }
{%- endstyle -%}

<div class="ingredients-optimized section-{{ section.id }}-padding color-{{ section.settings.color_scheme }} gradient">
  <div class="section section--page-width">
    <div class="ingredients-optimized__header">
      {%- if section.settings.heading != blank -%}
        <h2 class="ingredients-optimized__title">{{ section.settings.heading }}</h2>
      {%- endif -%}
      {%- if section.settings.description != blank -%}
        <div class="ingredients-optimized__description">{{ section.settings.description }}</div>
      {%- endif -%}
      {%- if section.settings.cta_text != blank -%}
        <a href="{{ section.settings.cta_link }}" class="ingredients-optimized__cta">
          {{ section.settings.cta_text }}
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
            <path d="M1 7h12m0 0l-4-4m4 4l-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      {%- endif -%}
    </div>

    {%- liquid
      assign categories = 'View All'
      for block in section.blocks
        unless categories contains block.settings.category
          assign categories = categories | append: ',' | append: block.settings.category
        endunless
      endfor
      assign category_array = categories | split: ','
    -%}

    <div class="ingredients-optimized__nav-wrapper">
      <div class="ingredients-optimized__nav no-scrollbar">
        {%- for cat in category_array -%}
          <button
            class="ingredients-optimized__tab {% if forloop.first %}is-active{% endif %}"
            data-category="{{ cat }}"
          >
            {{ cat }}
          </button>
        {%- endfor -%}
      </div>
    </div>

    <div class="ingredients-optimized__grid">
      {%- for block in section.blocks -%}
        <div
          class="ingredient-card"
          data-category="{{ block.settings.category }}"
          data-index="{{ forloop.index0 }}"
          {{ block.shopify_attributes }}
        >
          <span class="ingredient-card__category">{{ block.settings.category }}</span>
          <div class="ingredient-card__image-wrapper">
            {%- if block.settings.image != blank -%}
              {{
                block.settings.image
                | image_url: width: 300
                | image_tag: class: 'ingredient-card__image', loading: 'lazy'
              }}
            {%- else -%}
              {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
            {%- endif -%}
          </div>
          <h3 class="ingredient-card__title">{{ block.settings.title }}</h3>

          {% comment %} Hidden content for modal population {% endcomment %}
          <div class="ingredient-data" style="display: none;">
            <div class="modal-what">{{ block.settings.what_it_is }}</div>
            <div class="modal-benefits">{{ block.settings.benefits }}</div>
            <div class="modal-image-src">{{ block.settings.image | image_url: width: 600 }}</div>
          </div>
        </div>
      {%- endfor -%}
    </div>
  </div>
</div>

{% comment %} Modal Structure {% endcomment %}
<div id="IngredientsModal" class="ingredients-modal">
  <div class="ingredients-modal__overlay"></div>
  <div class="ingredients-modal__container">
    <div class="ingredients-modal__header">
      <span class="ingredients-modal__cat"></span>
      <button class="ingredients-modal__close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M18 6L6 18M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="ingredients-modal__media">
      <img src="" alt="" class="ingredients-modal__image">
    </div>

    <div class="ingredients-modal__content">
      <h2 class="ingredients-modal__title"></h2>

      <div class="ingredients-modal__section">
        <h4 class="ingredients-modal__section-title">What</h4>
        <div class="ingredients-modal__section-text modal-what-text"></div>
      </div>

      <div class="ingredients-modal__section">
        <h4 class="ingredients-modal__section-title">Benefits</h4>
        <div class="ingredients-modal__section-text modal-benefits-text"></div>
      </div>
    </div>

    <div class="ingredients-modal__nav">
      <div class="ingredients-modal__nav-controls">
        <button class="ingredients-modal__nav-btn modal-prev">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M19 12H5m0 0l7-7m-7 7l7 7"/>
          </svg>
        </button>
        <button class="ingredients-modal__nav-btn modal-next">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M5 12h14m0 0l-7-7m7 7l-7 7"/>
          </svg>
        </button>
      </div>
      <span class="ingredients-modal__counter">1 of 4</span>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const section = document.querySelector('.ingredients-optimized');
    if (!section) return;

    const tabs = section.querySelectorAll('.ingredients-optimized__tab');
    const cards = section.querySelectorAll('.ingredient-card');
    const modal = document.getElementById('IngredientsModal');
    const modalContainer = modal.querySelector('.ingredients-modal__container');
    const modalOverlay = modal.querySelector('.ingredients-modal__overlay');
    const closeBtn = modal.querySelector('.ingredients-modal__close');
    const prevBtn = modal.querySelector('.modal-prev');
    const nextBtn = modal.querySelector('.modal-next');

    let currentVisibleIndices = Array.from(cards).map((_, i) => i);
    let currentModalIndex = 0;

    // Filtering logic
    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        const category = tab.dataset.category;

        // Update tabs
        tabs.forEach((t) => t.classList.remove('is-active'));
        tab.classList.add('is-active');

        // Update cards
        currentVisibleIndices = [];
        cards.forEach((card, index) => {
          if (category === 'View All' || card.dataset.category === category) {
            card.removeAttribute('data-ingredient-hidden');
            currentVisibleIndices.push(index);
          } else {
            card.setAttribute('data-ingredient-hidden', 'true');
          }
        });
      });
    });

    // Modal logic
    function updateModal(visibleIndex) {
      if (visibleIndex < 0 || visibleIndex >= currentVisibleIndices.length) return;

      const actualIndex = currentVisibleIndices[visibleIndex];
      const card = cards[actualIndex];
      const data = card.querySelector('.ingredient-data');

      modal.querySelector('.ingredients-modal__cat').textContent = card.dataset.category;
      modal.querySelector('.ingredients-modal__title').textContent =
        card.querySelector('.ingredient-card__title').textContent;
      modal.querySelector('.modal-what-text').innerHTML = data.querySelector('.modal-what').innerHTML;

      // Handle optional benefits
      const benefitsContent = data.querySelector('.modal-benefits').innerHTML;
      const benefitsContainer = modal.querySelector('.modal-benefits-text').closest('.ingredients-modal__section');
      if (benefitsContent.trim()) {
        modal.querySelector('.modal-benefits-text').innerHTML = benefitsContent;
        benefitsContainer.style.display = 'block';
      } else {
        benefitsContainer.style.display = 'none';
      }

      modal.querySelector('.ingredients-modal__image').src = data.querySelector('.modal-image-src').textContent;

      currentModalIndex = visibleIndex;
      modal.querySelector('.ingredients-modal__counter').textContent = `${visibleIndex + 1} of ${
        currentVisibleIndices.length
      }`;

      prevBtn.disabled = visibleIndex === 0;
      nextBtn.disabled = visibleIndex === currentVisibleIndices.length - 1;
    }

    cards.forEach((card, index) => {
      card.addEventListener('click', () => {
        const visibleIndex = currentVisibleIndices.indexOf(index);
        updateModal(visibleIndex);
        modal.classList.add('is-active');
        document.body.style.overflow = 'hidden';
      });
    });

    function closeModal() {
      modal.classList.remove('is-active');
      document.body.style.overflow = '';
    }

    closeBtn.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', closeModal);

    prevBtn.addEventListener('click', () => {
      if (currentModalIndex > 0) updateModal(currentModalIndex - 1);
    });

    nextBtn.addEventListener('click', () => {
      if (currentModalIndex < currentVisibleIndices.length - 1) updateModal(currentModalIndex + 1);
    });

    // Handle ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('is-active')) {
        closeModal();
      }
      // Arrow keys
      if (modal.classList.contains('is-active')) {
        if (e.key === 'ArrowLeft' && currentModalIndex > 0) updateModal(currentModalIndex - 1);
        if (e.key === 'ArrowRight' && currentModalIndex < currentVisibleIndices.length - 1)
          updateModal(currentModalIndex + 1);
      }
    });
  });
</script>

{% schema %}
{
  "name": "Ingredients Optimized",
  "tag": "section",
  "settings": [
    {
      "type": "inline_richtext",
      "id": "heading",
      "label": "Heading",
      "default": "High-quality ingredients optimized for impact"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description",
      "default": "<p>We don’t think you should settle for questionable ingredients when it comes to your daily nutrition. AG1’s ingredients are sourced from quality partners for absorption, potency, and nutrient density.</p>"
    },
    {
      "type": "text",
      "id": "cta_text",
      "label": "CTA Text",
      "default": "See what goes into every scoop of AG1"
    },
    {
      "type": "url",
      "id": "cta_link",
      "label": "CTA Link"
    },
    {
      "type": "header",
      "content": "Color Scheme"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 160,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 80
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 160,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 80
    }
  ],
  "blocks": [
    {
      "type": "ingredient",
      "name": "Ingredient",
      "settings": [
        {
          "type": "text",
          "id": "category",
          "label": "Category",
          "default": "Vitamins & Minerals"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Ingredient Name",
          "default": "Citrus Bioflavonoids"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "richtext",
          "id": "what_it_is",
          "label": "What it is",
          "default": "<p>Bioflavonoids are a group of plant compounds that are found in the rinds of citrus fruits.</p>"
        },
        {
          "type": "richtext",
          "id": "benefits",
          "label": "Benefits (Bullet Points)",
          "default": "<ul><li>Supports a healthy stress response</li><li>Promotes mood balance</li></ul>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Ingredients Optimized",
      "blocks": [
        {
          "type": "ingredient",
          "settings": {
            "category": "Vitamins & Minerals",
            "title": "Vitamin E"
          }
        },
        {
          "type": "ingredient",
          "settings": {
            "category": "Whole Food Sourced",
            "title": "Pea Protein"
          }
        },
        {
          "type": "ingredient",
          "settings": {
            "category": "Digestive Support",
            "title": "Apple"
          }
        },
        {
          "type": "ingredient",
          "settings": {
            "category": "Digestive Support",
            "title": "Inulin"
          }
        },
        {
          "type": "ingredient",
          "settings": {
            "category": "Vitamins & Minerals",
            "title": "Zinc"
          }
        }
      ]
    }
  ]
}
{% endschema %}
